---
title: "RE 04"
weight: 4
# bookFlatSection: false
# bookToc: true
bookHidden: true 
# bookCollapseSection: false
# bookComments: false
# bookSearchExclude: false
# bookHref: ''
---
# Challenges.re - RE 04

## Question

Reverse Engineering challenge #4.

Tags: .

What does this code do?

Some versions have the 0x1010101 constant, some do not. Why?

## Assembly Code 

```nasm
mov    edx,edi
shr    edx,1
and    edx,0x55555555
sub    edi,edx
mov    eax,edi
shr    edi,0x2
and    eax,0x33333333
and    edi,0x33333333
add    edi,eax
mov    eax,edi
shr    eax,0x4
add    eax,edi
and    eax,0xf0f0f0f
imul   eax,eax,0x1010101
shr    eax,0x18
ret
```


| Command | Arg1 | Arg2       | Arg3      | pseudo-code       | comment                                                            |
| ------- | ---- | ---------- | --------- | ----------------- | ------------------------------------------------------------------ |
| MOV     | EDX  | EDI        |           | EDX = EDI         | EDI can be a function arg                                          |
| SHR     | EDX  | 1          |           | EDX >>= 1         |                                                                    |
| AND     | EDX  | 0x55555555 |           | EDX &= 0x55555555 | 0x55555555 or<br>01010101010101010101010101010101 or<br>1431655765 |
| SUB     | EDI  | EDX        |           | EDI -= EDX        |                                                                    |
| MOV     | EAX  | EDI        |           | EAX = EDI         |                                                                    |
| SHR     | EDI  | 0x2        |           | EDI >>= 2         |                                                                    |
| AND     | EAX  | 0x33333333 |           | EAX &= 0x33333333 | 0x33333333 or<br>00110011001100110011001100110011 or<br>858993459  |
| AND     | EDI  | 0x33333333 |           | EDI &= 0x33333333 |                                                                    |
| ADD     | EDI  | EAX        |           | EDI += EAX        |                                                                    |
| MOV     | EAX  | EDI        |           | EAX = EDI         |                                                                    |
| SHR     | EAX  | 0x4        |           | EAX >>= 0x4       |                                                                    |
| ADD     | EAX  | EDI        |           | EAX += EDI        |                                                                    |
| AND     | EAX  | 0xf0f0f0f  |           | EAX &= 0xf0f0f0f  | 0xf0f0f0f or <br>00001111000011110000111100001111 or<br>252645135  |
| IMUL    | EAX  | EAX        | 0x1010101 | EAX \*= 0x1010101 | 0x1010101 or<br>00000001000000010000000100000001 or<br>16843009    |
| SHR     | EAX  | 0x18       |           | EAX >>= 0x18      | 0x18 or<br>00011000 or<br>24                                       |
| RET     |      |            |           |                   |                                                                    |

Tese primária, o código conta quantos bits são 1. 

000 = 0  
001 = 1  
010 = 1  
011 = 2  
100 = 1  
101 = 2  
111 = 3  


